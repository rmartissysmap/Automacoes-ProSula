<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Minhas Prioridades - Gestão de Chamados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e9eef2;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-top: 5px solid #0070d2;
            position: relative; 
        }
        h1 { color: #1a1a1a; font-size: 2em; margin-bottom: 5px; text-align: center; }
        h2 { color: #6a6a6a; font-size: 1.1em; font-weight: 300; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; margin-bottom: 20px; text-align: center; }
        
        /* NOVO ESTILO PARA O LINK DE VOLTAR (Borda removida) */
        .back-link {
            position: absolute;
            top: 25px;
            left: 25px;
            text-decoration: none;
            color: #0070d2;
            font-weight: 600;
            font-size: 0.9em;
            padding: 5px 10px;
            border: none; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .back-link:hover {
            background-color: #e6f7ff;
            text-decoration: underline;
        }

        /* Formulário de Input */
        .input-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background-color: #f5f5f5;
            align-items: center;
        }
        .input-form input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 40px;
            box-sizing: border-box;
        }
        .input-form button {
            padding: 10px 20px;
            background-color: #0070d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            height: 40px;
        }
        .input-form button:hover {
            background-color: #005aa3;
        }
        
        /* Controles de Visualização e Transferência */
        #viewControl {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background-color: #f5f5f5;
        }
        #viewControl label {
            font-weight: 600;
            margin-right: 10px;
            color: #333;
        }
        #viewControl select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 250px;
        }
        #transferSection {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #transferSection button {
            background-color: #c53929;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #transferSection button:hover {
             background-color: #a32e22;
        }


        /* Lista de Prioridades (Drag and Drop) */
        #priorityList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        /* Adicionado para dar estilo de prioridade */
        #priorityList li:not(.status-done) {
             border-left: 5px solid #ffa000; /* Laranja para itens pendentes/prioritários */
        }
        #priorityList li.status-done {
             border-left: 5px solid #2E7D32; /* Verde para itens concluídos */
        }

        #priorityList li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #ffffff;
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #priorityList li:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #priorityList li.dragging {
            opacity: 0.5;
            border: 2px dashed #0070d2;
        }
        
        /* Status do Chamado */
        .handle {
            cursor: move;
            margin-right: 15px;
            color: #ccc;
            font-size: 1.2em;
        }
        .ticket-title {
            flex-grow: 1;
            font-weight: 600;
        }
        .status-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .status-pending {
            background-color: #f0f0f0;
            color: #6a6a6a;
        }
        .status-done {
            background-color: #E8F5E9; /* Verde Claro */
            color: #2E7D32; /* Verde Escuro */
            border: 1px solid #2E7D32;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #c53929;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.1em;
        }

        /* Estatísticas e Resumo */
        .stats-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .stats-box {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            width: 32%;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .stats-box h4 {
            margin-top: 0;
            color: #0070d2;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .stats-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1a1a1a;
        }
        .total-done { color: #2E7D32; }
        
        /* Estilo para ADM */
        #admStats {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #0070d2;
            display: none; /* CORREÇÃO: Começa oculto e o JS exibe se for ADM */
        }
        #admStats h3 {
            color: #0070d2;
            text-align: center;
        }
        #admStats table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        #admStats th, #admStats td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        #admStats th {
            background-color: #0070d2;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">&larr; Voltar para Gestão de Solicitações</a>
        
        <h1 id="pageTitle">Minhas Prioridades</h1>
        <h2 id="userNameDisplay">Usuário: Carregando...</h2>

        <div id="viewControl" style="display: none;">
            <label for="viewUserSelect">Visualizando Prioridades de:</label>
            <select id="viewUserSelect" onchange="changeViewUser(this.value)">
                </select>

            <div id="transferSection" style="display: none;">
                <label for="transferTicketSelect">Transferir Ticket:</label>
                <select id="transferTicketSelect" style="width: 200px;">
                    <option value="">Selecione um Ticket</option>
                </select>
                <label for="transferUserSelect">para</label>
                <select id="transferUserSelect" style="width: 150px;">
                    <option value="">Selecione um Usuário</option>
                </select>
                <button onclick="transferTicket()">Transferir</button>
            </div>
        </div>
        
        <div id="addTicketForm" style="display: none;">
            <h3>Adicionar Novo Chamado</h3>
            <div class="input-form">
                <input type="text" id="ticketInput" placeholder="Ex: SUP-12345, EXP-4567890" pattern="[A-Z]{3,5}-\d{4,7}" title="O formato deve ser XXX-1234 ou XXXXX-1234567" required>
                <button onclick="addTicket()">Adicionar</button>
            </div>
            <div id="formMessage" style="color: red; text-align: center; margin-bottom: 10px;"></div>
        </div>


        <h3>Chamados Priorizados (Arraste para reordenar)</h3>
        <ul id="priorityList">
            </ul>
        <div id="emptyMessage" style="text-align: center; color: #6a6a6a; margin-top: 20px; display: none;">Nenhum chamado priorizado.</div>

        <div id="userStats" class="stats-section">
            <div class="stats-box">
                <h4>Atendidos Hoje</h4>
                <div id="todayCount" class="stats-value total-done">0</div>
            </div>
            <div class="stats-box">
                <h4>Atendidos na Semana</h4>
                <div id="weekCount" class="stats-value total-done">0</div>
            </div>
            <div class="stats-box">
                <h4>Atendidos no Mês</h4>
                <div id="monthCount" class="stats-value total-done">0</div>
            </div>
        </div>

        <div id="admStats">
            <h3>Resumo Mensal de Chamados Priorizados por Usuário</h3>
            <div style="overflow-x: auto;">
                <table id="admTable">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Total Priorizado (Mês)</th>
                            <th>Total Atendido (Mês)</th>
                            <th>% Conclusão</th>
                            <th>% Pendente</th> </tr>
                    </thead>
                    <tbody id="admTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variável global
        let LOGGED_IN_USER = 'Visitante'; // Usuário que fez login
        let CURRENT_VIEW_USER = ''; // Usuário cuja lista está sendo exibida (pode ser o próprio ou outro)
        
        const PRIORITY_STORAGE_PREFIX = 'userPriorities_';
        const USER_STORAGE_KEY = 'automationUserList'; // Para obter todos os usuários
        
        // Mapeamento de hierarquia (Júnior/Sênior)
        const HIERARCHY = {
            'LUCAS': 'DIEGO',
            'NEDSON': 'VINICIUS'
            // Matheus não tem júnior mapeado, mas é sênior
        };

        const SENIORS = ['DIEGO', 'VINICIUS', 'MATHEUS'];
        const ADM_USERS = ['ADM'];

        // --- UTILS ---

        function formatName(name) {
            if (!name) return '';
            let cleanedName = name.trim().toLowerCase();
            return cleanedName.split(' ').map(word => {
                if (word.length === 0) return '';
                if (word.length > 2 || word === cleanedName.split(' ')[0]) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join(' ');
        }
        
        function isAdm(user) {
             return ADM_USERS.includes(formatName(user).toUpperCase());
        }
        
        function isSenior(user) {
             return SENIORS.includes(formatName(user).toUpperCase());
        }

        // --- FUNÇÕES DE PERSISTÊNCIA ---

        function getStorageKey(userName) {
            return PRIORITY_STORAGE_PREFIX + formatName(userName).replace(/\s/g, '_');
        }

        function loadTickets(userName) {
            const key = getStorageKey(userName);
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }

        function saveTickets(userName, tickets) {
            const key = getStorageKey(userName);
            localStorage.setItem(key, JSON.stringify(tickets));
        }
        
        function loadAllUsers() {
            let users = localStorage.getItem(USER_STORAGE_KEY);
            // Filtra 'Selecione seu Nome...' para não aparecer em listas
            return users ? JSON.parse(users).filter(u => u.toUpperCase() !== 'SELECIONE SEU NOME...') : [];
        }

        // --- FUNÇÕES DE CADASTRO E STATUS ---

        function addTicket() {
            const input = document.getElementById('ticketInput');
            const message = document.getElementById('formMessage');
            const title = input.value.trim().toUpperCase();

            if (CURRENT_VIEW_USER !== LOGGED_IN_USER) {
                 showMessage('Você só pode adicionar tickets à sua própria lista de prioridades.');
                 return;
            }

            if (!title || !/^[A-Z]{3,5}-\d{4,7}$/.test(title)) {
                message.textContent = 'Formato inválido. Use 3 a 5 letras (XXX-), seguidas de 4 a 7 dígitos (1234-1234567).';
                return;
            }

            const tickets = loadTickets(LOGGED_IN_USER);
            if (tickets.some(t => t.title === title)) {
                message.textContent = `O chamado ${title} já está na sua lista de prioridades.`;
                return;
            }

            const newTicket = {
                id: Date.now(),
                title: title,
                done: false,
                doneDate: ''
            };

            tickets.push(newTicket); 
            saveTickets(LOGGED_IN_USER, tickets);
            input.value = '';
            message.textContent = '';
            renderList();
            updateStats();
        }

        function toggleDone(id) {
            // Apenas o usuário que possui a lista ou o ADM pode alterar o status
            if (CURRENT_VIEW_USER !== LOGGED_IN_USER && !isAdm(LOGGED_IN_USER)) {
                 showMessage('Você não tem permissão para alterar o status desta lista.', 'orange');
                 return;
            }

            const tickets = loadTickets(CURRENT_VIEW_USER);
            const index = tickets.findIndex(t => t.id == id);

            if (index !== -1) {
                const isDone = tickets[index].done;
                tickets[index].done = !isDone;
                tickets[index].doneDate = !isDone ? new Date().toISOString() : '';
                
                saveTickets(CURRENT_VIEW_USER, tickets);
                reorderOnStatusChange(id, !isDone); 
            }
        }
        
        function reorderOnStatusChange(id, isDone) {
            let tickets = loadTickets(CURRENT_VIEW_USER);
            const ticketIndex = tickets.findIndex(t => t.id == id);
            
            if (ticketIndex === -1) return;

            const ticket = tickets.splice(ticketIndex, 1)[0];
            
            if (isDone) {
                // Se FINALIZADO, vai para o FIM da lista
                tickets.push(ticket);
            } else {
                // Se voltando para PENDENTE, vai para o INÍCIO da lista
                tickets.unshift(ticket);
            }

            saveTickets(CURRENT_VIEW_USER, tickets);
            renderList();
            updateStats();
        }
        
        // --- FUNÇÕES DE HIERARQUIA E TRANSFERÊNCIA ---

        function getHierarchicalUsers() {
            const loggedUser = formatName(LOGGED_IN_USER).toUpperCase();
            let viewableUsers = [LOGGED_IN_USER];
            const allUsers = loadAllUsers();

            if (isAdm(LOGGED_IN_USER)) {
                // ADM vê todos
                viewableUsers = allUsers;

            } else if (isSenior(LOGGED_IN_USER)) {
                // Sênior vê a si mesmo e seus juniores
                for (const junior in HIERARCHY) {
                    if (HIERARCHY[junior] === loggedUser) {
                        // Encontra o nome completo do junior
                        const juniorFullName = allUsers.find(u => formatName(u).toUpperCase() === junior);
                        if (juniorFullName) {
                           viewableUsers.push(juniorFullName);
                        }
                    }
                }
            }
            // Garante que só há nomes de usuários completos e formatados
            return viewableUsers.map(formatName).filter((value, index, self) => self.indexOf(value) === index);
        }

        function populateViewSelect(viewableUsers) {
            const select = document.getElementById('viewUserSelect');
            const users = viewableUsers.sort();
            
            select.innerHTML = '';
            
            let defaultSet = false;

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                
                // Tenta manter a visualização no usuário logado por padrão
                if (user === LOGGED_IN_USER && !defaultSet) {
                    option.selected = true;
                    CURRENT_VIEW_USER = LOGGED_IN_USER;
                    defaultSet = true;
                } else if (users.length > 1 && !defaultSet) {
                    // Se for o primeiro da lista visível (ex: Sênior vendo Júnior)
                    option.selected = true;
                    CURRENT_VIEW_USER = user;
                    defaultSet = true;
                }
                select.appendChild(option);
            });
            
            // Se houver mais de uma opção, ou se for ADM, exibe o controle
            if (users.length > 1 || isAdm(LOGGED_IN_USER)) {
                document.getElementById('viewControl').style.display = 'block';
            }
        }
        
        function populateTransferSelects(viewableUsers) {
            const selectTarget = document.getElementById('transferUserSelect');
            const selectTicket = document.getElementById('transferTicketSelect');
            
            selectTarget.innerHTML = '<option value="">Selecione Destino</option>';
            selectTicket.innerHTML = '<option value="">Selecione um Ticket</option>';

            const allUsers = loadAllUsers();
            
            // Populando destinos (todos os outros usuários, exceto o de visualização)
            allUsers.map(formatName).sort().filter(u => u !== CURRENT_VIEW_USER).forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                selectTarget.appendChild(option);
            });
            
            // Populando tickets do usuário em visualização
            const tickets = loadTickets(CURRENT_VIEW_USER).filter(t => !t.done); // Apenas pendentes
            tickets.forEach(ticket => {
                const option = document.createElement('option');
                option.value = ticket.id;
                option.textContent = ticket.title;
                selectTicket.appendChild(option);
            });
        }
        
        function changeViewUser(newViewUser) {
            CURRENT_VIEW_USER = newViewUser;
            
            // Controla a visibilidade do formulário de adicionar ticket
            const addForm = document.getElementById('addTicketForm');
            addForm.style.display = (newViewUser === LOGGED_IN_USER) ? 'block' : 'none';

            // Controla a visibilidade da seção de transferência
            if (isAdm(LOGGED_IN_USER)) {
                document.getElementById('transferSection').style.display = 'flex';
                populateTransferSelects(getHierarchicalUsers()); 
            } else {
                 document.getElementById('transferSection').style.display = 'none';
            }
            
            renderList();
            updateStats();
        }

        function transferTicket() {
            if (!isAdm(LOGGED_IN_USER)) return;
            
            const ticketId = document.getElementById('transferTicketSelect').value;
            const targetUser = document.getElementById('transferUserSelect').value;
            const sourceUser = CURRENT_VIEW_USER; 
            
            if (!ticketId || !targetUser) {
                showMessage('Selecione um Ticket e um Usuário de Destino para a transferência.');
                return;
            }
            
            if (sourceUser === targetUser) {
                showMessage('Origem e Destino não podem ser o mesmo usuário.', 'orange');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja transferir o ticket selecionado de ${sourceUser} para ${targetUser}?`)) {
                return;
            }
            
            // 1. Remove do usuário de origem
            let sourceTickets = loadTickets(sourceUser);
            const ticketIndex = sourceTickets.findIndex(t => t.id == ticketId);
            
            if (ticketIndex === -1) {
                showMessage('Erro: Ticket não encontrado na lista de origem.', 'red');
                return;
            }
            
            const [ticketToTransfer] = sourceTickets.splice(ticketIndex, 1);
            saveTickets(sourceUser, sourceTickets);
            
            // 2. Adiciona ao usuário de destino (como prioridade máxima, no topo)
            let targetTickets = loadTickets(targetUser);
            targetTickets.unshift(ticketToTransfer); // Adiciona no início
            saveTickets(targetUser, targetTickets);
            
            showMessage(`Ticket ${ticketToTransfer.title} transferido de ${sourceUser} para ${targetUser} com sucesso.`, 'green');
            
            // Renderiza novamente a lista de origem
            document.getElementById('transferTicketSelect').value = ''; 
            document.getElementById('transferUserSelect').value = '';
            renderList();
            updateStats();
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO E ESTATÍSTICAS (Ajustadas para CURRENT_VIEW_USER) ---
        
        function renderList() {
            const ul = document.getElementById('priorityList');
            // Carrega tickets do usuário em visualização
            const tickets = loadTickets(CURRENT_VIEW_USER); 
            ul.innerHTML = '';

            // Se for ADM, atualiza o seletor de tickets para transferência
            if (isAdm(LOGGED_IN_USER)) {
                populateTransferSelects(getHierarchicalUsers()); 
            }

            if (tickets.length === 0) {
                document.getElementById('emptyMessage').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyMessage').style.display = 'none';
            }

            // O drag-and-drop e exclusão só são permitidos na sua própria lista (ou se for ADM)
            const canEditOrder = (CURRENT_VIEW_USER === LOGGED_IN_USER || isAdm(LOGGED_IN_USER));
            const canDeleteTicket = canEditOrder;


            tickets.forEach(ticket => {
                const li = document.createElement('li');
                li.setAttribute('draggable', canEditOrder ? 'true' : 'false');
                li.setAttribute('data-id', ticket.id);
                li.className = ticket.done ? 'status-done' : 'status-pending'; 

                // Handle de Arraste (Mover)
                const handle = document.createElement('span');
                handle.className = 'handle';
                handle.innerHTML = canEditOrder ? '&#9776;' : '&#9679;'; // Ícone diferente se não for arrastável
                li.appendChild(handle);

                // Título
                const titleSpan = document.createElement('span');
                titleSpan.className = 'ticket-title';
                titleSpan.textContent = ticket.title;
                li.appendChild(titleSpan);

                // Botão de Status (Permitido para o próprio usuário ou ADM)
                const statusBtn = document.createElement('button');
                const statusClass = ticket.done ? 'status-done' : 'status-pending';
                statusBtn.className = 'status-btn ' + statusClass;
                statusBtn.textContent = ticket.done ? 'Atendido' : 'Pendente';
                statusBtn.disabled = !canEditOrder; // Desabilita se for apenas visualizador
                statusBtn.onclick = () => toggleDone(ticket.id);
                li.appendChild(statusBtn);

                // Botão de Excluir (Permitido apenas para o próprio usuário ou ADM)
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&#10006;'; 
                deleteBtn.disabled = !canDeleteTicket; 
                deleteBtn.onclick = () => deleteTicket(ticket.id);
                li.appendChild(deleteBtn);

                ul.appendChild(li);
            });
            if (canEditOrder) {
                setupDragAndDrop();
            }
        }
        
        function updateStats() {
            // As estatísticas agora se referem ao CURRENT_VIEW_USER
            const tickets = loadTickets(CURRENT_VIEW_USER);
            const doneTickets = tickets.filter(t => t.done && t.doneDate);

            function getTodayKey() { return new Date().toLocaleDateString('pt-BR'); }
            function getWeekKey(date) { 
                const d = new Date(date); const day = d.getDay(); 
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
                const startOfWeek = new Date(d.setDate(diff)); 
                return startOfWeek.toLocaleDateString('pt-BR'); 
            }
            function getMonthKey(date) { return `${new Date(date).getMonth() + 1}/${new Date(date).getFullYear()}`; }
            
            const today = getTodayKey();
            const thisWeek = getWeekKey(new Date());
            const thisMonth = getMonthKey(new Date());

            let todayCount = 0;
            let weekCount = 0;
            let monthCount = 0;
            
            doneTickets.forEach(ticket => {
                const doneDate = new Date(ticket.doneDate);
                const ticketWeek = getWeekKey(doneDate);
                const ticketMonth = getMonthKey(doneDate);

                if (doneDate.toLocaleDateString('pt-BR') === today) {
                    todayCount++;
                }
                if (ticketWeek === thisWeek) {
                    weekCount++;
                }
                if (ticketMonth === thisMonth) {
                    monthCount++;
                }
            });

            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('monthCount').textContent = monthCount;

            if (isAdm(LOGGED_IN_USER)) {
                renderAdmStats(thisMonth);
            }
        }
        
        // --- Drag and Drop (mantida, mas só ativa se canEditOrder for true) ---
        let dragListItem = null;

        function setupDragAndDrop() {
            const list = document.getElementById('priorityList');
            const listItems = list.querySelectorAll('li');

            listItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            // Verifica se o item é arrastável
            if (this.getAttribute('draggable') === 'false') {
                e.preventDefault();
                return;
            }
            dragListItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function saveReorder() {
            const list = document.getElementById('priorityList');
            const items = Array.from(list.children);
            const originalTickets = loadTickets(CURRENT_VIEW_USER);
            
            const reorderedTickets = items.map(item => {
                const id = item.getAttribute('data-id');
                return originalTickets.find(t => t.id == id);
            }).filter(t => t); 

            saveTickets(CURRENT_VIEW_USER, reorderedTickets);
            renderList(); 
        }
        
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; if (this !== dragListItem) { this.style.borderTop = '2px solid #0070d2'; } }
        function handleDragLeave() { this.style.borderTop = ''; }
        function handleDrop(e) { e.preventDefault(); this.style.borderTop = ''; if (dragListItem !== this) { const isAfter = dragListItem.compareDocumentPosition(this) & Node.DOCUMENT_POSITION_FOLLOWING; if (isAfter) { this.parentNode.insertBefore(dragListItem, this.nextSibling); } else { this.parentNode.insertBefore(dragListItem, this); } saveReorder(); } }
        function handleDragEnd() { this.classList.remove('dragging'); dragListItem = null; }

        // --- Funções ADM (Estatísticas e Renderização) ---

        function getAllUsers() {
            const allKeys = Object.keys(localStorage);
            return allKeys
                .filter(key => key.startsWith(PRIORITY_STORAGE_PREFIX))
                .map(key => key.replace(PRIORITY_STORAGE_PREFIX, '').replace(/_/g, ' '));
        }

        function renderAdmStats(currentMonthKey) {
            const admTableBody = document.getElementById('admTableBody');
            admTableBody.innerHTML = '';
            
            const allUserNames = getAllUsers();
            const summary = [];

            allUserNames.forEach(userNameKey => {
                const userTicketsKey = PRIORITY_STORAGE_PREFIX + userNameKey.replace(/\s/g, '_');
                const storedTickets = localStorage.getItem(userTicketsKey);
                const tickets = storedTickets ? JSON.parse(storedTickets) : [];

                // Lógica de cálculo 
                let totalPrioritized = 0;
                let totalAttended = 0;
                
                tickets.forEach(t => {
                    const creationDate = new Date(t.id);
                    const ticketMonth = getMonthKey(creationDate); 
                    
                    // Conta o Total Priorizado (criado neste mês)
                    if (ticketMonth === currentMonthKey) {
                        totalPrioritized++;
                    }
                    
                    // Conta o Total Atendido (concluído neste mês)
                    if (t.done && t.doneDate) {
                        const doneMonth = getMonthKey(new Date(t.doneDate));
                        if (doneMonth === currentMonthKey) {
                            totalAttended++;
                        }
                    }
                });

                // CÁLCULO DAS PORCENTAGENS
                const completionRate = totalPrioritized > 0 ? (totalAttended / totalPrioritized) * 100 : 0;
                
                // % Pendente é o complemento da % Conclusão (0% se Total Priorizado for 0)
                const percentagePending = totalPrioritized > 0 ? (100 - completionRate) : 0;


                summary.push({
                    user: userNameKey,
                    prioritized: totalPrioritized,
                    attended: totalAttended,
                    rate: completionRate.toFixed(1),
                    pendingRate: percentagePending.toFixed(1)
                });
            });

            // Ordena pelo total de atendidos (decrescente)
            summary.sort((a, b) => b.attended - a.attended);
            
            summary.forEach(data => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${data.user}</td>
                    <td>${data.prioritized}</td>
                    <td>${data.attended}</td>
                    <td>${data.rate}%</td>
                    <td>${data.pendingRate}%</td>
                `;
                admTableBody.appendChild(tr);
            });
        }


        // --- Inicialização ---

        function initPage() {
            const lastUser = localStorage.getItem('lastUser');
            
            if (lastUser) {
                LOGGED_IN_USER = formatName(lastUser); 
                document.getElementById('userNameDisplay').textContent = 'Usuário: ' + LOGGED_IN_USER;
            } else {
                alert('Usuário não identificado. Redirecionando para o login.');
                window.location.href = 'index.html'; 
                return;
            }
            
            const viewableUsers = getHierarchicalUsers();
            
            // Popula o seletor de visualização e define o usuário inicial
            populateViewSelect(viewableUsers);
            
            // Se o usuário inicial (CURRENT_VIEW_USER) ainda for 'Visitante', define como o primeiro da lista
            if (CURRENT_VIEW_USER === 'Visitante' && viewableUsers.length > 0) {
                 CURRENT_VIEW_USER = viewableUsers[0];
            }
            
            // Verifica se o formulário de adicionar ticket deve ser exibido (se estiver vendo a própria lista)
            if (CURRENT_VIEW_USER === LOGGED_IN_USER) {
                 document.getElementById('addTicketForm').style.display = 'block';
            }

            // Configura a visibilidade do painel ADM e de transferência
            if (isAdm(LOGGED_IN_USER)) {
                 document.getElementById('admStats').style.display = 'block'; // CORRIGIDO: Exibe se for ADM
                 document.getElementById('transferSection').style.display = 'flex';
                 populateTransferSelects(viewableUsers);
            } else {
                // Esconde a seção ADM para não ADMs
                document.getElementById('admStats').style.display = 'none';
            }
            
            renderList();
            updateStats();
        }

        window.onload = initPage;
    </script>
</body>
</html>
