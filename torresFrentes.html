<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Automatização - Gestão de Torres e Frentes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos Base (MESMO CSS DO OUTRO ARQUIVO) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px; 
            background-color: #e9eef2;
        }
        .container { 
            max-width: 900px; /* Um pouco menor para gestão */
            margin: 0 auto; 
            background-color: white; 
            padding: 40px; 
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #0070d2;
            position: relative; 
        }
        
        h1 { color: #1a1a1a; font-size: 2.2em; margin-bottom: 5px; text-align: center; }
        h2 { color: #6a6a6a; font-size: 1.2em; font-weight: 300; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; margin-bottom: 30px; text-align: center; }
        .tool-section { min-height: 200px; padding: 10px; }

        /* Estilos específicos da Gestão */
        .management-form {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background-color: #f5f5f5;
        }
        .management-form input[type="text"],
        .management-form select {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;
            background-color: white; /* Garante fundo branco para select */
        }
        .management-form button {
            padding: 10px; background-color: #0070d2; color: white; border: none; border-radius: 4px;
            cursor: pointer; transition: background-color 0.2s;
            height: 40px; /* Altura fixa */
            align-self: end;
        }
        .management-form button:hover { background-color: #005aa3; }

        /* Link para voltar (AJUSTADO PARA POSIÇÃO E SEM BORDA) */
        .back-link {
            position: absolute;
            top: 25px; /* Alinha com o topo */
            left: 25px; /* Alinha à esquerda */
            text-decoration: none;
            color: #0070d2;
            font-weight: 600;
            font-size: 0.9em;
            padding: 5px 10px;
            border: none; /* Borda Removida */
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .back-link:hover { 
            text-decoration: underline; 
            background-color: #e6f7ff; /* Adiciona um hover suave */
        }
        #adminMessage {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            height: 1.2em; /* Evita que o layout pule */
        }

        /* Estilo dos Cards das Torres */
        .torre-card {
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .torre-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px; /* Espaçamento */
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap; /* Quebra de linha em telas pequenas */
        }
        .torre-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* ATUALIZAÇÃO: NOME DA TORRE (EDITÁVEL PARA ADM) */
        .torre-header-info span {
            font-size: 1.3em;
            font-weight: 600;
            color: #0070d2;
            padding: 4px 8px;
        }
        .torre-name-input {
            font-size: 1.3em;
            font-weight: 600;
            color: #0070d2;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            background-color: #ffffff;
            max-width: 250px; /* Limita a largura do input */
        }
        .torre-name-input:focus {
            outline: 2px solid #0070d2;
            background-color: #f0faff;
        }

        .torre-lider-select {
            font-weight: 600;
            color: #1a1a1a;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
            padding: 4px;
        }

        .delete-btn {
            background: none; border: 1px solid #c53929; color: #c53929;
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
            font-size: 0.9em; font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap; /* Evita quebra de linha */
        }
        .delete-btn:hover { background-color: #c53929; color: white; }

        /* Lista de Frentes */
        .frente-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .frente-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #e9e9e9;
        }
        .frente-list li:last-child {
            border-bottom: none;
        }
        .frente-list li span {
            font-weight: 500;
            word-break: break-word; /* Quebra nomes longos de frente */
            padding-right: 10px;
        }
        
        /* Formulário de Adicionar Frente (dentro do card) */
        .frente-form {
            display: grid;
            grid-template-columns: 1fr 100px; 
            gap: 10px;
            padding: 15px 20px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
        }
         .frente-form input {
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;
         }
         .frente-form button {
            padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px;
            cursor: pointer; transition: background-color 0.2s;
            font-weight: 600;
         }
         .frente-form button:hover { background-color: #218838; }
         
         @media (max-width: 600px) {
            .frente-form {
                grid-template-columns: 1fr; /* Empilha em telas pequenas */
            }
         }

    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-link">&larr; Voltar para Gestão de Solicitações</a>
        
        <h1>Gestão de Torres e Frentes</h1>
        <h2>Adicione torres, frentes e líderes responsáveis</h2>
        
        <div class="tool-section">
            
            <h3>Adicionar Nova Torre</h3>
            <div class="management-form">
                <input type="text" id="newTorreName" placeholder="Nome da Nova Torre (Ex: Atendimento)" required>
                <button id="addTorreButton">Adicionar Torre</button>
            </div>
            
            <div id="adminMessage" style="color: red;"></div>

            <h3>Torres e Frentes Atuais</h3>
            <div id="torresListContainer">
                </div>
        </div>
    </div>
    
    <script>
        // CHAVES COMPARTILHADAS (IDÊNTICAS AO index.html)
        const USER_STORAGE_KEY = 'automationUserList'; 
        const TORRE_STORAGE_KEY = 'automationTowersList'; 
        const REQUEST_STORAGE_KEY = 'automationRequests'; // <-- CHAVE DAS SOLICITAÇÕES
        
        // --- ATUALIZAÇÃO DE PERMISSÃO ---
        const AUTHORIZED_EDITORS = ['ADM'];
        let IS_ADM = false; // Flag de permissão

        
        const DEFAULT_TORRES_DATA = [
            {
                id: 1678886400001,
                nome: "Delta",
                liderPadrao: "Vinicius", 
                frentes: [
                    { id: 101, nome: "ProSula", lider: "Vinicius" },
                    { id: 102, nome: "Relacionamento (Gestão de Leads, Transf, Com e Rex)", lider: "Vinicius" },
                    { id: 103, nome: "Cadastro Prestador/Reembolso", lider: "Vinicius" },
                    { id: 104, nome: "Contas Médicas", lider: "Vinicius" }
                ]
            },
            {
                id: 1678886400002,
                nome: "Sigma",
                liderPadrao: "Diego", 
                frentes: [
                    { id: 201, nome: "Auditoria/Fraude", lider: "Diego" },
                    { id: 202, nome: "CSP", lider: "Diego" },
                    { id: 203, nome: "Sourcing", lider: "Diego" }
                ]
            },
            {
                id: 1678886400003,
                nome: "Gama",
                liderPadrao: "Matheus", 
                frentes: [
                    { id: 301, nome: "Cotador/Multicanalidade (Comercial)", lider: "Matheus" },
                    { id: 302, nome: "VPP", lider: "A definir" },
                    { id: 303, nome: "Health Cloud", lider: "Matheus" },
                    { id: 304, nome: "Marketing", lider: "Matheus" }
                ]
            }
        ];

        // --- FUNÇÕES DE DADOS (localStorage) ---

        function loadUserList() {
            let users = localStorage.getItem(USER_STORAGE_KEY);
            if (!users) return []; 
            return JSON.parse(users).filter(u => 
                u.toUpperCase() !== 'SELECIONE SEU NOME...' &&
                u.toUpperCase() !== 'ADM'
            ).sort(); 
        }

        function loadTowers() {
            let towers = localStorage.getItem(TORRE_STORAGE_KEY);
            if (!towers) {
                saveTowers(DEFAULT_TORRES_DATA);
                return DEFAULT_TORRES_DATA; 
            }
            return JSON.parse(towers);
        }

        function saveTowers(towers) {
            localStorage.setItem(TORRE_STORAGE_KEY, JSON.stringify(towers));
        }
        
        // --- ATUALIZAÇÃO: Carrega as solicitações (para atualizar nomes) ---
        function loadRequests() {
            let requests = localStorage.getItem(REQUEST_STORAGE_KEY);
            return requests ? JSON.parse(requests) : [];
        }
        
        function saveRequests(requests) {
             localStorage.setItem(REQUEST_STORAGE_KEY, JSON.stringify(requests));
        }
        
        function formatName(name) {
            if (!name) return '';
            let cleanedName = name.trim().toLowerCase();
            return cleanedName.split(' ').map(word => {
                if (word.length === 0) return '';
                if (word.length > 2 || word === cleanedName.split(' ')[0]) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join(' ');
        }
        
        function formatFrenteName(name) {
             if (!name) return '';
             let cleanedName = name.trim();
             if (cleanedName.length === 0) return '';
             return cleanedName.charAt(0).toUpperCase() + cleanedName.slice(1);
        }
        
        // --- ATUALIZAÇÃO: Funções de Login (só para checar ADM) ---
        function isAuthorized(user) {
            if (!user) return false;
            const cleanUser = formatName(user).toUpperCase().trim(); 
            return AUTHORIZED_EDITORS.includes(cleanUser); // Apenas 'ADM'
        }
        
        function checkLogin() {
            const lastUser = localStorage.getItem('lastUser');
            if (lastUser && isAuthorized(lastUser)) {
                IS_ADM = true;
            } else {
                IS_ADM = false;
            }
        }
        

        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---

        function renderTorres() {
            const container = document.getElementById('torresListContainer');
            const towers = loadTowers();
            const users = loadUserList(); 
            
            container.innerHTML = ''; 
            
            if (towers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6a6a6a;">Nenhuma torre cadastrada ainda.</p>';
                return;
            }

            towers.forEach(torre => {
                const torreCard = document.createElement('div');
                torreCard.className = 'torre-card';

                // 1. Header da Torre
                const torreHeader = document.createElement('div');
                torreHeader.className = 'torre-header';
                
                const torreInfo = document.createElement('div');
                torreInfo.className = 'torre-header-info';
                
                // --- ATUALIZAÇÃO: NOME DA TORRE (Editável se ADM) ---
                if (IS_ADM) {
                    const torreNameInput = document.createElement('input');
                    torreNameInput.type = 'text';
                    torreNameInput.className = 'torre-name-input'; 
                    torreNameInput.value = torre.nome;
                    torreNameInput.onblur = (e) => {
                        // Salva o nome antigo para atualizar as solicitações
                        const nomeAntigo = torre.nome;
                        updateTorreName(torre.id, e.target.value, nomeAntigo);
                    };
                    torreInfo.appendChild(torreNameInput);
                } else {
                    const torreNameSpan = document.createElement('span');
                    torreNameSpan.textContent = torre.nome;
                    torreInfo.appendChild(torreNameSpan);
                }
                // --- FIM DA ATUALIZAÇÃO ---

                // Select de Líder da TORRE
                const liderSelect = document.createElement('select');
                liderSelect.className = 'torre-lider-select';
                liderSelect.disabled = !IS_ADM; // Desabilitado se não for ADM
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    if (formatName(user) === formatName(torre.liderPadrao)) {
                        option.selected = true;
                    }
                    liderSelect.appendChild(option);
                });
                
                const aDefinirOption = document.createElement('option');
                aDefinirOption.value = "A definir";
                aDefinirOption.textContent = "A definir";
                if (torre.liderPadrao === "A definir") {
                    aDefinirOption.selected = true;
                }
                liderSelect.appendChild(aDefinirOption);

                liderSelect.onchange = (e) => {
                    updateLiderTorre(torre.id, e.target.value);
                };
                
                torreInfo.appendChild(liderSelect); 

                const deleteTorreBtn = document.createElement('button');
                deleteTorreBtn.textContent = 'Excluir Torre';
                deleteTorreBtn.className = 'delete-btn';
                deleteTorreBtn.disabled = !IS_ADM; // Desabilitado se não for ADM
                deleteTorreBtn.onclick = () => deleteTorre(torre.id);

                torreHeader.appendChild(torreInfo);
                torreHeader.appendChild(deleteTorreBtn);
                torreCard.appendChild(torreHeader);

                // 2. Lista de Frentes
                const frenteList = document.createElement('ul');
                frenteList.className = 'frente-list';

                if (torre.frentes.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Nenhuma frente cadastrada nesta torre.';
                    li.style.color = '#9e9e9e';
                    frenteList.appendChild(li);
                } else {
                    torre.frentes.forEach(frente => {
                        const li = document.createElement('li');
                        
                        const infoSpan = document.createElement('span');
                        infoSpan.innerHTML = `${frente.nome}`;
                        
                        li.appendChild(infoSpan);
                        
                        const deleteFrenteBtn = document.createElement('button');
                        deleteFrenteBtn.textContent = 'Excluir';
                        deleteFrenteBtn.className = 'delete-btn';
                        deleteFrenteBtn.style.fontSize = '0.8em';
                        deleteFrenteBtn.disabled = !IS_ADM; // Desabilitado se não for ADM
                        deleteFrenteBtn.onclick = () => deleteFrente(torre.id, frente.id);
                        
                        li.appendChild(deleteFrenteBtn);
                        frenteList.appendChild(li);
                    });
                }
                torreCard.appendChild(frenteList);

                // 3. Formulário para Adicionar Frente (SÓ APARECE PARA ADM)
                if (IS_ADM) {
                    const frenteForm = document.createElement('div');
                    frenteForm.className = 'frente-form';
                    
                    const frenteNameInput = document.createElement('input');
                    frenteNameInput.type = 'text';
                    frenteNameInput.placeholder = 'Nome da Nova Frente';
                    frenteNameInput.id = `frente-nome-${torre.id}`; 
                    
                    const addFrenteBtn = document.createElement('button');
                    addFrenteBtn.textContent = 'Adicionar';
                    addFrenteBtn.onclick = () => {
                        addFrente(torre.id, frenteNameInput.value);
                    };

                    frenteForm.appendChild(frenteNameInput);
                    frenteForm.appendChild(addFrenteBtn);
                    torreCard.appendChild(frenteForm);
                }

                container.appendChild(torreCard);
            });
        }
        
        // --- FUNÇÕES DE CRUD (Torres e Frentes) ---

        function showMessage(text, color = 'red') {
            const messageDiv = document.getElementById('adminMessage');
            messageDiv.style.color = color;
            messageDiv.textContent = text;
            
            setTimeout(() => {
                if (messageDiv.textContent === text) {
                    messageDiv.textContent = '';
                }
            }, 3000);
        }

        // Adiciona uma nova TORRE
        function addTorre() {
            if (!IS_ADM) return; // Segurança
            const input = document.getElementById('newTorreName');
            const torreName = formatName(input.value); 
            
            if (!torreName || torreName.length < 3) {
                showMessage('O nome da torre deve ter pelo menos 3 caracteres.');
                return;
            }
            
            const towers = loadTowers();
            const torreExists = towers.some(t => formatName(t.nome) === torreName); 
            
            if (torreExists) {
                showMessage(`A torre "${torreName}" já existe.`);
                return;
            }
            
            towers.push({
                id: Date.now(),
                nome: torreName,
                liderPadrao: "A definir", 
                frentes: [] 
            });
            
            saveTowers(towers);
            renderTorres(); 
            
            showMessage(`Torre "${torreName}" adicionada com sucesso!`, 'green');
            input.value = '';
        }
        
        // Deleta uma TORRE
        function deleteTorre(torreId) {
            if (!IS_ADM) return;
            if (window.confirm('Tem certeza que deseja excluir esta torre e TODAS as suas frentes?')) {
                let towers = loadTowers();
                towers = towers.filter(t => t.id !== torreId);
                saveTowers(towers);
                renderTorres();
                showMessage('Torre excluída com sucesso.', 'green');
            }
        }

        // Adiciona uma FRENTE a uma torre específica
        function addFrente(torreId, frenteName) {
            if (!IS_ADM) return;
            frenteName = formatFrenteName(frenteName); 

            if (!frenteName) {
                showMessage('O nome da frente é obrigatório.');
                return;
            }

            const towers = loadTowers();
            const torre = towers.find(t => t.id === torreId);
            
            if (!torre) {
                 showMessage('Erro: Torre não encontrada.');
                 return;
            }
            
            const liderName = torre.liderPadrao; 

            const frenteExists = torre.frentes.some(f => f.nome.toLowerCase() === frenteName.toLowerCase());
            if (frenteExists) {
                showMessage(`A frente "${frenteName}" já existe nesta torre.`);
                return;
            }
            
            torre.frentes.push({
                id: Date.now(), 
                nome: frenteName, 
                lider: formatName(liderName) 
            });
            
            saveTowers(towers);
            renderTorres(); 
        }
        
        // Deleta uma FRENTE
        function deleteFrente(torreId, frenteId) {
            if (!IS_ADM) return;
            if (window.confirm('Tem certeza que deseja excluir esta frente?')) {
                const towers = loadTowers();
                const torre = towers.find(t => t.id === torreId);
                
                if (torre) {
                    torre.frentes = torre.frentes.filter(f => f.id !== frenteId);
                    saveTowers(towers);
                    renderTorres();
                }
            }
        }
        
        // ATUALIZA O LÍDER da TORRE e de todas as FRENTES
        function updateLiderTorre(torreId, novoLider) {
            if (!IS_ADM) return;
            const towers = loadTowers();
            const torre = towers.find(t => t.id === torreId);
            if (!torre) return;
            
            const liderFormatado = formatName(novoLider);
            
            torre.liderPadrao = liderFormatado;
            torre.frentes.forEach(frente => {
                frente.lider = liderFormatado;
            });
            
            saveTowers(towers);
            
            showMessage(`Líder da torre "${torre.nome}" atualizado para "${liderFormatado}".`, 'green');
            
            // Re-renderiza para mostrar os líderes atualizados nas frentes (se estivéssemos mostrando eles)
            renderTorres(); 
        }
        
        // --- ATUALIZAÇÃO: Renomeia a TORRE ---
        function updateTorreName(torreId, novoNome, nomeAntigo) {
             if (!IS_ADM) return;
             novoNome = formatName(novoNome);
             nomeAntigo = formatName(nomeAntigo);
             
             if (novoNome === nomeAntigo) return; // Nenhum
             
             if (!novoNome || novoNome.length < 3) {
                showMessage('O nome da torre deve ter pelo menos 3 caracteres.');
                renderTorres(); // Reverte
                return;
            }
            
            const towers = loadTowers();
            const torre = towers.find(t => t.id === torreId);
            if (!torre) return;
            
            const nomeExiste = towers.some(t => t.id !== torreId && formatName(t.nome) === novoNome);
            if (nomeExiste) {
                showMessage(`O nome "${novoNome}" já está em uso por outra torre.`);
                renderTorres(); // Reverte
                return;
            }
            
            // 1. Atualiza o nome na lista de torres
            torre.nome = novoNome;
            saveTowers(towers);
            
            // 2. ATUALIZA O NOME EM TODAS AS SOLICITAÇÕES EXISTENTES (Reflete no index.html)
            let requests = loadRequests();
            requests.forEach(req => {
                if (req.torreId === torreId) {
                    // (Não precisamos atualizar o nome se o index.html usar IDs)
                }
            });
            
            showMessage(`Nome da torre atualizado para "${novoNome}".`, 'green');
            // Re-renderiza para garantir que o input tenha o nome formatado
            renderTorres();
        }


        // Inicialização da página
        window.onload = () => {
            checkLogin(); // <-- VERIFICA A PERMISSÃO DE ADM
            renderTorres();
            
            // Só permite adicionar se for ADM
            const addButton = document.getElementById('addTorreButton');
            addButton.onclick = addTorre;
            
            if (!IS_ADM) {
                document.getElementById('newTorreName').disabled = true;
                addButton.disabled = true;
                addButton.style.backgroundColor = '#9e9e9e';
                addButton.style.cursor = 'not-allowed';
            }
        };
    </script>
</body>
</html>
