<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Automatização</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px; 
            background-color: #e9eef2;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background-color: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #0070d2; 
        }
        h1 { 
            color: #1a1a1a; 
            font-size: 2.2em; 
            margin-bottom: 5px;
            text-align: center;
        }
        h2 { 
            color: #6a6a6a; 
            font-size: 1.2em; 
            font-weight: 300;
            border-bottom: 2px solid #e0e0e0; 
            padding-bottom: 10px; 
            margin-top: 0;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* --- ESTILOS ESPECÍFICOS DA FERRAMENTA --- */
        .tool-section h3 { color: #0070d2; margin-top: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        
        /* Contêineres de Input de ID (2 colunas) */
        .id-input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .id-input-item {
            flex: 1; /* Distribui o espaço igualmente */
        }
        .id-input-item input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: Consolas, monospace;
        }
        
        /* Estilo comum para as áreas de texto (Input/Output) */
        textarea {
            width: 100%; 
            padding: 15px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-family: Consolas, monospace; 
            font-size: 14px; 
            margin-bottom: 15px;
        }

        /* Estilo específico para a área de Input de Colagem */
        textarea#dataInput { height: 200px; border: 1px solid #005fb2; }
        
        /* Estilo específico para a área de Output (Script Apex) */
        textarea#apexCode { 
            height: 400px; 
            border: 1px solid #28a745; 
            background-color: #f8fff8; 
            white-space: pre; 
            margin-bottom: 0; 
        }

        /* Contêineres de alinhamento para botões (Centralização) */
        .button-center-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        /* Botões */
        button { 
            padding: 12px 20px; 
            background-color: #0070d2; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 0;
            transition: background-color 0.3s; 
        }
        button:hover { background-color: #005fb2; }

        /* Botão de Copiar */
        .copy-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-top: 10px; 
        }
        #copyStatus { font-weight: bold; color: #28a745; margin-left: 15px; opacity: 0; transition: opacity 0.5s; }
        .copy-button { background-color: #28a745; padding: 8px 15px; }
        .copy-button:hover { background-color: #1e7e34; }

        /* Mensagens e Exemplos */
        /* Estilo da caixa de Disclaimer (Regras de Validação) */
        .disclaimer { 
            margin-top: 25px; 
            padding: 15px; 
            background-color: #ffe0b2; 
            border-left: 5px solid #ff9800; 
            color: #5d4037; 
            border-radius: 4px; 
        }
        
        /* Estilo da caixa de Exemplo (Formato Esperado) */
        .example { 
            margin-top: 10px; 
            padding: 10px; 
            background-color: #e9ecef; 
            border-left: 5px solid #0070d2; 
        }
        
        /* Remove o negrito das Regras (Mantendo o layout) */
        .disclaimer * {
            font-weight: normal !important; 
        }
        .disclaimer strong { /* Garante que o título do bloco de regras não tenha negrito, mas os exemplos internos sim */
            font-weight: normal !important;
        }
        /* Mantém o negrito do título principal do exemplo */
        .example strong {
            font-weight: bold !important; 
        }

        .error-message { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Automatização</h1>
        <h2>Frente - Cotador/Comercial</h2>
        
        <div class="tool-section">
            <h3>Criador de Script Apex</h3>

            <label>1. Insira os IDs de Pesquisa Obrigatórios:</label>
            <div class="id-input-group">
                <div class="id-input-item">
                    <label for="contaIdInput">ID da Conta (001...)</label>
                    <input type="text" id="contaIdInput" placeholder="Ex: 001Z000000ABCDE18">
                </div>
                <div class="id-input-item">
                    <label for="atuacaoIdInput">ID da Atuação (a20...)</label>
                    <input type="text" id="atuacaoIdInput" placeholder="Ex: a200Z000000XYZW15678">
                </div>
            </div>

            <label for="dataInput">2. Cole aqui o restante das informações da lista (11 campos):</label>
            
            <div class="example">
                <p><strong>Formato Esperado (Modelo com dados fictícios).</strong></p>
                <pre>Código da EA = 99999
Nome da EA - Estrutura Teste Apoio
Código da EV = 01234567 
Nome da EV - Corretora Teste Vendas
Código da Filial = 01 - FILIAL TESTE
Nome da Filial - UNI FILIAL TESTE - GERENTE FICTÍCIO
Código da UOP = 1010
Código do Produtor - 01234567 
CNPJ da corretora = 00000000000000
Data de Inicio - 01/01/2026
Se é filial ativa = Sim</pre>
            </div>
            
            <textarea id="dataInput" placeholder="Cole os 11 campos restantes aqui."></textarea>
            
            <div class="button-center-container">
                <button onclick="generateApex()">3. Gerar Script Apex de Insert</button>
            </div>

            <textarea id="apexCode" readonly placeholder="O script de Insert aparecerá aqui no formato direto."></textarea>

            <div class="copy-container">
                <div>
                    <button class="copy-button" onclick="copyApexCode()">Copiar Script</button>
                    <span id="copyStatus">Copiado!</span>
                </div>
            </div>

            <div class="disclaimer">
                <strong>REGRAS DE VALIDAÇÃO ESTREITA:</strong>
                <ul>
                    <li>O ID da Conta deve ser um ID Salesforce válido (15 ou 18 caracteres).</li>
                    <li>O ID da Atuação pode ter 15, 18 ou até 19 caracteres.</li>
                    <li>O Código da EV e o Código do Produtor devem ter exatamente 8 dígitos.</li>
                    <li>O campo Data de Início deve usar separadores de barra (/) ou traço (-).</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Mapeamento dos Nomes da Lista (esquerda) para os Tokens de Substituição (direita)
        const FIELD_MAPPING = {
            'código da ea': 'VALOR_CODIGO_EA',
            'nome da ea': 'VALOR_NOME_EA',
            'código da ev': 'VALOR_CODIGO_EV',
            'nome da ev': 'VALOR_NOME_EV',
            'código da filial': 'VALOR_CODIGO_FILIAL',
            'nome da filial': 'VALOR_NOME_FILIAL',
            'código da uop': 'VALOR_CODIGO_UOP',
            'código do produtor': 'VALOR_CODIGO_PRODUTOR',
            'cnpj da corretora': 'VALOR_CNPJ',
            'id da conta': 'VALOR_CONTA_ID',       // Este virá do input separado
            'id da atuação': 'VALOR_ATUACAO_ID',   // Este virá do input separado
            'data de inicio': 'VALOR_DATA_INICIO',
            'se é filial ativa': 'VALOR_FILIAL_ATIVA',
        };

        // Valores de Template
        const TEMPLATE_VALUES = {
            'RECORDTYPE_ID': '0123l0000001lczAAAS',
            'DATA_FIM_VALUE': 'null',
        };

        let dateValidationError = null; 
        const TOTAL_FIELDS_EXPECTED = Object.keys(FIELD_MAPPING).length; // 13 campos

        /**
         * Função para formatar valores.
         */
        function formatValue(token, value) {
            value = value.trim();
            dateValidationError = null; 

            if (token === 'VALOR_DATA_INICIO') {
                if (!value.includes('/') && !value.includes('-')) {
                    dateValidationError = `Data de Início (Valor: ${value}) está incorreta. Deve usar '/' ou '-' como separador (Ex: DD/MM/AAAA).`;
                    return `'${value}' /* ERRO: FORMATO DE DATA INVÁLIDO */`; 
                }
                
                const cleanedValue = value.replace(/-/g, '/').trim(); 
                const parts = cleanedValue.split('/');
                
                if (parts.length === 3) {
                    const [day, month, year] = parts;
                    return `Date.newInstance(${year}, ${month}, ${day})`;
                }

                dateValidationError = `Data de Início (Valor: ${value}) está incorreta. Deve ter o formato DD/MM/AAAA ou DD-MM-AAAA.`;
                return `'${value}' /* ERRO: ESTRUTURA DE DATA INVÁLIDA */`;
            }

            if (token === 'VALOR_FILIAL_ATIVA') {
                if (value.toLowerCase() === 'sim' || value.toLowerCase() === 'true') return 'True';
                return 'False';
            }
            
            return `'${value}'`;
        }
        
        /**
         * Aplica o preenchimento com zeros (zero-padding) à esquerda.
         */
        function zeroPad(str, size) {
            let s = String(str);
            s = s.replace(/\D/g, ''); 
            while (s.length < size) {
                s = '0' + s;
            }
            return s;
        }

        /**
         * Valida se um código tem EXATAMENTE o tamanho desejado (8 para EV e Produtor).
         */
        function validateStrictLength(value, expectedLength) {
            const cleanValue = String(value || '').replace(/\D/g, '').trim();
            if (cleanValue.length === expectedLength) {
                return cleanValue;
            }
            return null; 
        }

        /**
         * Valida se um ID é um ID Salesforce padrão (15 ou 18 caracteres).
         */
        function validateSalesforceId(value) {
            const cleanValue = String(value || '').trim();
            if (cleanValue.length === 15 || cleanValue.length === 18) {
                return cleanValue;
            }
            return null;
        }
        
        /**
         * Valida se o ID da Atuação tem 15, 18 ou 19 caracteres.
         */
        function validateActuationId(value) {
            const cleanValue = String(value || '').trim();
            if (cleanValue.length === 15 || cleanValue.length === 18 || cleanValue.length === 19) {
                return cleanValue;
            }
            return null;
        }

        /**
         * Geração da CHAVE_EXTERNA__c.
         */
        function generateChaveExterna(codEv, codEa) {
            if (!codEv || !codEa) return "'CHAVE INVÁLIDA - FALTANDO DADOS'";

            const evPadded = codEv; 
            const eaPadded = zeroPad(codEa, 5); 

            const chaveFinal = 
                'CP000' + 
                evPadded + 
                '000' + 
                eaPadded + 
                '000' + 
                evPadded;

            return `'${chaveFinal}'`;
        }

        /**
         * EXTRAÇÃO DE DADOS (ACEITA ' - ' ou ' = ')
         */
        function extractData(inputText) {
            const data = {};
            const lines = inputText.split('\n').filter(line => line.trim().length > 0); 

            lines.forEach(line => {
                let key = '';
                let value = '';
                let separator = null;
                let separatorLength = 0;
                
                // Prioridade 1: Separador " = "
                const eqIndex = line.indexOf(' = ');
                if (eqIndex !== -1) {
                    separator = ' = ';
                    separatorLength = 3;
                } 
                
                // Prioridade 2: Separador " - "
                const dashIndex = line.indexOf(' - ');
                if (separator === null && dashIndex !== -1) {
                    separator = ' - ';
                    separatorLength = 3;
                }
                
                if (separator !== null) {
                    const separatorIndex = line.indexOf(separator);
                    key = line.substring(0, separatorIndex).trim();
                    value = line.substring(separatorIndex + separatorLength).trim();
                } 
                else {
                    const firstSpaceIndex = line.indexOf(' ');
                    if (firstSpaceIndex > 0) {
                        key = line.substring(0, firstSpaceIndex).trim();
                        value = line.substring(firstSpaceIndex + 1).trim();
                    } else {
                        return;
                    }
                }

                if (key && value) {
                    // Normaliza a chave para comparação
                    const normalizedKey = key.toLowerCase().replace(/[^a-z0-9 ]/g, '').trim();

                    for (const mapKey in FIELD_MAPPING) {
                        if (normalizedKey === mapKey.replace(/[^a-z0-9 ]/g, '').trim()) {
                            const token = FIELD_MAPPING[mapKey];
                            data[token] = value;
                            return; 
                        }
                    }
                }
            });

            return data;
        }

        function generateApex() {
            // Coleta dados dos inputs separados (IDs)
            const contaIdInput = document.getElementById('contaIdInput').value.trim();
            const atuacaoIdInput = document.getElementById('atuacaoIdInput').value.trim();
            
            // Coleta dados da área de colagem (11 campos)
            const inputText = document.getElementById('dataInput').value;
            const dynamicData = extractData(inputText);
            
            const apexCodeArea = document.getElementById('apexCode');
            const copyStatus = document.getElementById('copyStatus');
            
            // Adiciona os IDs coletados dos inputs ao objeto de dados
            if (contaIdInput) dynamicData['VALOR_CONTA_ID'] = contaIdInput;
            if (atuacaoIdInput) dynamicData['VALOR_ATUACAO_ID'] = atuacaoIdInput;

            // 1. Validação de extração mínima (13 campos)
            if (Object.keys(dynamicData).length < TOTAL_FIELDS_EXPECTED) {
                apexCodeArea.value = `// ERRO: Não foi possível extrair dados suficientes. Apenas ${Object.keys(dynamicData).length} de ${TOTAL_FIELDS_EXPECTED} campos encontrados.
// Verifique se os IDs e os 11 campos restantes foram preenchidos corretamente.`;
                apexCodeArea.classList.add('error-message');
                copyStatus.style.opacity = 0; 
                return;
            }
            apexCodeArea.classList.remove('error-message');
            
            let errors = [];

            // 2. Validação Estrita do Código da EV (8 dígitos)
            const codigoEVValidado = validateStrictLength(dynamicData.VALOR_CODIGO_EV, 8);
            if (!codigoEVValidado) {
                errors.push(`Código da EV (Valor: ${dynamicData.VALOR_CODIGO_EV || 'Vazio'}) deve ter EXATAMENTE 8 dígitos.`);
            }

            // 3. Validação Estrita do Código do Produtor (8 dígitos)
            const codigoProdutorValidado = validateStrictLength(dynamicData.VALOR_CODIGO_PRODUTOR, 8);
            if (!codigoProdutorValidado) {
                 errors.push(`Código do Produtor (Valor: ${dynamicData.VALOR_CODIGO_PRODUTOR || 'Vazio'}) deve ter EXATAMENTE 8 dígitos.`);
            }
            
            // 4. Validação da Data de Início
            const dataInicioApex = formatValue('VALOR_DATA_INICIO', dynamicData.VALOR_DATA_INICIO); 
            if (dateValidationError) {
                 errors.push(dateValidationError);
            }
            
            // 5. Validação da Conta (15 ou 18)
            const contaIdValidado = validateSalesforceId(dynamicData.VALOR_CONTA_ID);
            if (!contaIdValidado) {
                 errors.push(`ID da Conta (Valor: ${dynamicData.VALOR_CONTA_ID || 'Vazio'}) parece inválido. Deve ser um ID Salesforce de 18 caracteres.`);
            }

            // 6. Validação da Atuação (15, 18 ou 19)
            const atuacaoIdValidado = validateActuationId(dynamicData.VALOR_ATUACAO_ID);
            if (!atuacaoIdValidado) {
                 errors.push(`ID da Atuação (Valor: ${dynamicData.VALOR_ATUACAO_ID || 'Vazio'}) parece inválido. Deve ter 15, 18 ou 19 caracteres.`);
            }


            // 7. Se houver erro de validação, exibe e interrompe
            if (errors.length > 0) {
                const errorMessage = errors.map(e => `// - ${e}`).join('\n');
                apexCodeArea.value = `// ERRO DE VALIDAÇÃO ESTREITA:\n${errorMessage}\n// Por favor, corrija o(s) valor(es) na entrada e tente novamente. O script de Insert NÃO PODE ser gerado.`;
                apexCodeArea.classList.add('error-message');
                copyStatus.style.opacity = 0; 
                return;
            }

            // --- FIM DA VALIDAÇÃO ESTRITA ---

            // 8. GERAÇÃO DA CHAVE EXTERNA DINÂMICA (usa o EV validado)
            const chaveExterna = generateChaveExterna(
                codigoEVValidado, 
                dynamicData.VALOR_CODIGO_EA 
            );

            // 9. Formata os códigos validados para o script de Insert
            const codigoEVFormatado = `'${codigoEVValidado}'`;
            const codigoProdutorFormatado = `'${codigoProdutorValidado}'`;
            const contaIdFormatado = `'${contaIdValidado}'`;
            const atuacaoIdFormatado = `'${atuacaoIdValidado}'`; 


            // 10. Geração da sintaxe direta (Insert new SObject(...))
            const sObjectInitScript = `
Insert new DETALHE_DO_CORRETOR__c(
    ATUACAO__c = ${atuacaoIdFormatado} /*(ID DE PESQUISA DINÂMICO)*/,
    CHAVE_EXTERNA__c = ${chaveExterna},
    CODIGO_DA_ESTRUTURA_DE_APOIO__c = ${formatValue('VALOR_CODIGO_EA', dynamicData.VALOR_CODIGO_EA)},
    CODIGO_DA_ESTRUTURA_DE_VENDA__c = ${codigoEVFormatado},
    CODIGO_DA_FILIAL__c = ${formatValue('VALOR_CODIGO_FILIAL', dynamicData.VALOR_CODIGO_FILIAL)},
    CODIGO_DA_UOP__c = ${formatValue('VALOR_CODIGO_UOP', dynamicData.VALOR_CODIGO_UOP)},
    CODIGO_DO_PRODUTOR__c = ${codigoProdutorFormatado},
    CONTA__c = ${contaIdFormatado} /*(ID DE PESQUISA DINÂMICO)*/,
    DATA_DE_INICIO__c = ${dataInicioApex},
    DATA_FIM__c = ${TEMPLATE_VALUES.DATA_FIM_VALUE} /*(SEMPRE NULL)*/,
    FILIAL_ATIVA__c = ${formatValue('VALOR_FILIAL_ATIVA', dynamicData.VALOR_FILIAL_ATIVA)} /*(SEMPRE ATIVO)*/,
    NOME_DA_ESTRUTURA_DE_APOIO__c = ${formatValue('VALOR_NOME_EA', dynamicData.VALOR_NOME_EA)},
    NOME_DA_ESTRUTURA_DE_VENDA__c = ${formatValue('VALOR_NOME_EV', dynamicData.VALOR_NOME_EV)},
    NOME_DA_FILIAL__c = ${formatValue('VALOR_NOME_FILIAL', dynamicData.VALOR_NOME_FILIAL)},
    RecordTypeId = '${TEMPLATE_VALUES.RECORDTYPE_ID}' /*(NUNCA MUDA)*/
);
`;
            
            // 11. Limpeza: Remove a vírgula da penúltima linha
            let finalOutput = sObjectInitScript.trim().split('\n');
            finalOutput[finalOutput.length - 2] = finalOutput[finalOutput.length - 2].replace(/,$/, '');
            
            apexCodeArea.value = finalOutput.join('\n');
            copyStatus.style.opacity = 0; 
        }

        /**
         * Função para copiar o texto da textarea para a área de transferência.
         */
        function copyApexCode() {
            const apexCodeArea = document.getElementById('apexCode');
            const copyStatus = document.getElementById('copyStatus');
            
            if (apexCodeArea.classList.contains('error-message')) {
                alert('Não é possível copiar! O script gerado contém ERROS de validação. Por favor, corrija os dados de entrada.');
                return;
            }

            if (apexCodeArea.value.trim() === '') {
                alert('O script está vazio. Gere o script primeiro.');
                return;
            }

            // Usando a API Clipboard moderna
            navigator.clipboard.writeText(apexCodeArea.value).then(() => {
                copyStatus.style.opacity = 1; 
                setTimeout(() => {
                    copyStatus.style.opacity = 0; 
                }, 1500);
            }).catch(err => {
                // Fallback 
                apexCodeArea.select();
                document.execCommand('copy');
                copyStatus.textContent = 'Copiado (via fallback)!';
                copyStatus.style.opacity = 1;
                setTimeout(() => {
                    copyStatus.style.opacity = 0;
                    copyStatus.textContent = 'Copiado!'; 
                }, 1500);
            });
        }

        // Foco inicial no primeiro campo de ID
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('contaIdInput').focus(); 
        });
    </script>

</body>
</html>