<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>ADM - Distribuição de Chamados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px; 
            background-color: #e9eef2;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white; 
            padding: 40px; 
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #c53929; /* Cor ADM */
            position: relative; 
        }
        h1 { color: #1a1a1a; font-size: 2.2em; margin-bottom: 5px; text-align: center; }
        h2 { color: #6a6a6a; font-size: 1.2em; font-weight: 300; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; margin-bottom: 30px; text-align: center; }

        /* Estilo do Formulário */
        .distribuition-form {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.5fr;
            gap: 15px;
            padding: 20px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background-color: #f5f5f5;
            align-items: end;
        }
        .distribuition-form input[type="text"],
        .distribuition-form select {
            padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box;
            height: 40px;
        }
        .distribuition-form button {
            grid-column: 1 / span 3; /* Ocupa todas as colunas */
            padding: 12px; 
            background-color: #c53929; /* Vermelho ADM */
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer; 
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .distribuition-form button:hover { background-color: #a32e22; }
        
        .distribuition-form label {
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        /* Mensagem de Erro/Sucesso */
        #formMessage {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            min-height: 1.2em;
        }
        
        /* Link de Voltar */
        .back-link {
            position: absolute;
            top: 25px;
            left: 25px;
            text-decoration: none;
            color: #0070d2;
            font-weight: 600;
            font-size: 0.9em;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .back-link:hover { 
            text-decoration: underline; 
            background-color: #e6f7ff;
        }
        
        /* Estilo para tela de acesso negado */
        #accessDenied {
            text-align: center;
            padding-top: 50px;
            color: #c53929;
            font-size: 1.5em;
            font-weight: 600;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <a href="index.html" class="back-link">&larr; Voltar para Gestão de Solicitações</a>
        
        <h1 id="pageTitle">ADM - Distribuição de Chamados</h1>
        <h2 id="userNameDisplay">Tela exclusiva para administradores</h2>
        
        <div id="mainContent" style="display: none;">
            <div id="formMessage"></div>

            <div class="distribuition-form">
                
                <div>
                    <label for="ticketInput">Chamado (Ticket)</label>
                    <input type="text" id="ticketInput" placeholder="Ex: EXP-45728" 
                           pattern="[A-Z]{3,5}-\d{4,7}" 
                           title="Formato: 3-5 letras e 4-7 dígitos (Ex: XXX-1234)" required>
                </div>
                
                <div>
                    <label for="userSelect">Atribuir a</label>
                    <select id="userSelect">
                        <option value="">Selecione o Usuário</option>
                    </select>
                </div>
                
                <div>
                    <label for="frenteInput">Frente</label>
                    <input type="text" id="frenteInput" placeholder="Frente de Trabalho (Opcional)">
                </div>
                
                <button onclick="distributeTicket()">Distribuir e Priorizar Chamado</button>
            </div>
        </div>

        <div id="accessDenied" style="display: none;">
            Acesso negado. Esta área é restrita a usuários ADM.
        </div>
        
    </div>

    <script>
        // Chaves e Constantes
        const USER_STORAGE_KEY = 'automationUserList'; 
        const PRIORITY_STORAGE_PREFIX = 'userPriorities_'; // CHAVE DE PRIORIDADES
        const AUTHORIZED_EDITORS = ['ADM'];
        let CURRENT_USER = '';
        
        // --- UTILS ---
        
        function formatName(name) {
            if (!name) return '';
            let cleanedName = name.trim().toLowerCase();
            return cleanedName.split(' ').map(word => {
                if (word.length === 0) return '';
                if (word.length > 2 || word === cleanedName.split(' ')[0]) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join(' ');
        }
        
        function isAuthorized(user) {
            if (!user) return false;
            const cleanUser = formatName(user).toUpperCase().trim(); 
            return AUTHORIZED_EDITORS.includes(cleanUser); // Apenas 'ADM'
        }
        
        function loadUsersForSelect() {
            let users = localStorage.getItem(USER_STORAGE_KEY);
            if (!users) return []; 
            // Filtra o 'Selecione...' e o 'ADM' para não atribuir tarefas a eles
            return JSON.parse(users).filter(u => 
                u.toUpperCase() !== 'SELECIONE SEU NOME...' &&
                u.toUpperCase() !== 'ADM'
            ).sort(); 
        }

        // Preenche o Dropdown de Usuários
        function populateUserSelect() {
            const select = document.getElementById('userSelect');
            const users = loadUsersForSelect();
            
            select.innerHTML = '<option value="">Selecione o Usuário</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
        }
        
        // --- FUNÇÕES DE PRIORIZAÇÃO ---
        
        function getPriorityStorageKey(userName) {
            return PRIORITY_STORAGE_PREFIX + formatName(userName).replace(/\s/g, '_');
        }

        function loadUserTickets(userName) {
            const key = getPriorityStorageKey(userName);
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }

        function saveUserTickets(userName, tickets) {
            const key = getPriorityStorageKey(userName);
            localStorage.setItem(key, JSON.stringify(tickets));
        }

        function showMessage(text, color = 'red') {
            const messageDiv = document.getElementById('formMessage');
            messageDiv.style.color = color;
            messageDiv.textContent = text;
            
            setTimeout(() => {
                if (messageDiv.textContent === text) {
                    messageDiv.textContent = '';
                }
            }, 5000);
        }

        // Função Principal de Distribuição
        function distributeTicket() {
            const ticketInput = document.getElementById('ticketInput');
            const userSelect = document.getElementById('userSelect');
            const frenteInput = document.getElementById('frenteInput');
            
            const ticketTitle = ticketInput.value.trim().toUpperCase();
            const selectedUser = userSelect.value.trim();
            const frente = frenteInput.value.trim();
            
            // 1. Validação
            if (!/^[A-Z]{3,5}-\d{4,7}$/.test(ticketTitle)) {
                showMessage('Formato de Chamado inválido. Use 3-5 letras e 4-7 dígitos (Ex: XXX-1234).');
                return;
            }
            if (!selectedUser) {
                showMessage('Por favor, selecione um usuário para atribuir o chamado.');
                return;
            }

            // 2. Carrega lista do usuário
            const tickets = loadUserTickets(selectedUser);
            
            // 3. Checa duplicidade
            if (tickets.some(t => t.title === ticketTitle)) {
                showMessage(`O chamado ${ticketTitle} já existe na lista de prioridades de ${selectedUser}.`, 'red');
                return;
            }
            
            // 4. Cria Novo Chamado (Estrutura idêntica à do prioridades.html)
            const newTicket = {
                id: Date.now(),
                title: ticketTitle,
                done: false,
                doneDate: '',
                // Adiciona a frente como um dado extra (embora não seja exibido no prioridades.html, ajuda no contexto futuro)
                frente: frente || 'N/A' 
            };

            // 5. Adiciona NO FIM da lista de prioridades do usuário (comportamento de inclusão)
            tickets.push(newTicket); 
            
            // 6. Salva
            saveUserTickets(selectedUser, tickets);
            
            // 7. Feedback e Limpeza
            showMessage(`Chamado ${ticketTitle} distribuído com sucesso para ${selectedUser}.`, 'green');
            ticketInput.value = '';
            frenteInput.value = '';
            userSelect.selectedIndex = 0;
        }

        // --- INICIALIZAÇÃO ---
        
        window.onload = () => {
            const lastUser = localStorage.getItem('lastUser');
            
            if (lastUser && isAuthorized(lastUser)) {
                CURRENT_USER = formatName(lastUser);
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('pageTitle').textContent = `ADM - Distribuição de Chamados`;
                document.getElementById('userNameDisplay').textContent = `Usuário: ${CURRENT_USER}`;
                populateUserSelect();
            } else {
                document.getElementById('accessDenied').style.display = 'block';
                document.getElementById('pageTitle').textContent = 'Acesso Restrito';
                document.getElementById('userNameDisplay').textContent = '';
            }
        };
    </script>
</body>
</html>